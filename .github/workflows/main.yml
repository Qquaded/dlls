name: Build Release with GTK

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight UTC

permissions:
  contents: write  # Required to create releases

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Download and extract GTK4 package
      run: |
        Write-Host "Downloading GTK4 package..."
        $url = "https://repo.msys2.org/mingw/ucrt64/mingw-w64-ucrt-x86_64-gtk4-4.20.3-1-any.pkg.tar.zst"
        Invoke-WebRequest -Uri $url -OutFile "gtk4.pkg.tar.zst"
        
        Write-Host "Extracting package..."
        # Extract using tar (Windows 10+ has tar built-in)
        tar -xf gtk4.pkg.tar.zst
        
        Write-Host "Looking for DLLs..."
        $dlls = Get-ChildItem -Path "ucrt64\bin" -Filter "*.dll" -File
        Write-Host "Found $($dlls.Count) DLL files"
        
        Write-Host "Creating zip..."
        Compress-Archive -Path "ucrt64\bin\*" -DestinationPath "gtk-dlls.zip" -Force
        
        $zipSize = (Get-Item "gtk-dlls.zip").Length / 1MB
        Write-Host "Zip file created: $zipSize MB"
      shell: powershell
    
    - name: Create GitHub release
      uses: ncipollo/release-action@v1
      with:
        artifacts: gtk-dlls.zip
        tag: gtk-dlls-${{ github.run_number }}
        name: GTK DLLs Release ${{ github.run_number }}
        allowUpdates: true
